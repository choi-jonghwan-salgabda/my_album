<!DOCTYPE html>
<html>
<head>
    <title>유사 얼굴 찾기</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f4f4; color: #333; }
        .container { display: flex; gap: 20px; margin-top: 20px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-wrap: wrap; /* 반응형 고려 */ }
        .left-panel, .right-panel { flex: 1; min-width: 300px; /* 최소 너비 지정 */ }
        .right-panel { border-left: 1px solid #eee; padding-left: 20px; }
        h1, h2 { color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #uploadForm { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #uploadForm input[type="file"] { border: 1px solid #ccc; padding: 8px; border-radius: 4px; background-color: #fff; }
        #uploadForm button { padding: 10px 18px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        #uploadForm button:hover { background-color: #0056b3; }
        #uploadForm button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #result-list { list-style: none; padding: 0; border: 1px solid #eee; max-height: 65vh; overflow-y: auto; border-radius: 4px; background-color: #fff; }
        #result-list li { padding: 10px 12px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; transition: background-color 0.2s ease; gap: 10px; }
        #result-list li:last-child { border-bottom: none; }
        #result-list li:hover { background-color: #f0f8ff; }
        #result-list li.selected { background-color: #d0e0ff; font-weight: bold; }
        img.thumbnail { width: 45px; height: 45px; object-fit: cover; border: 1px solid #ccc; border-radius: 4px; flex-shrink: 0; /* 크기 고정 */ }
        .result-info { display: flex; flex-direction: column; font-size: 0.9em; overflow: hidden; /* 이름 길 경우 대비 */ }
        .result-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; /* 이름 길 경우 ... 처리 */ }
        .result-dist { color: #666; font-size: 0.85em; }
        #image-preview { text-align: center; min-height: 200px; /* 초기 높이 */ display: flex; align-items: center; justify-content: center; background-color: #fafafa; border-radius: 4px; border: 1px dashed #ccc; }
        #image-preview img { max-width: 100%; max-height: 75vh; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; }
        #image-preview p { color: #888; font-size: 0.9em; }
        #status-message { margin-top: 15px; font-weight: bold; color: #333; }
        #error-message { color: #dc3545; margin-top: 10px; font-weight: bold; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #007bff; width: 20px; height: 20px; animation: spin 1.5s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .right-panel { border-left: none; border-top: 1px solid #eee; padding-left: 0; padding-top: 20px; margin-top: 20px; }
            #result-list { max-height: 40vh; }
            #image-preview img { max-height: 50vh; }
        }
    </style>
</head>
<body>
    <h1>🔎 유사 얼굴 찾기</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="imageInput" name="image" accept="image/*" required>
        <button type="submit" id="submitButton">찾기</button>
        <div class="loader" id="loadingSpinner"></div>
    </form>
    <div id="status-message"></div>
    <div id="error-message"></div>

    <div class="container">
        <div class="left-panel">
            <h2>결과 목록</h2>
            <ul id="result-list">
                <!-- 검색 결과가 여기에 동적으로 추가됩니다 -->
            </ul>
        </div>
        <div class="right-panel">
            <h2>미리보기</h2>
            <div id="image-preview"><p>결과 목록에서 항목을 선택하세요.</p></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const imageInput = document.getElementById('imageInput');
        const submitButton = document.getElementById('submitButton');
        const resultList = document.getElementById('result-list');
        const previewDiv = document.getElementById('image-preview');
        const statusDiv = document.getElementById('status-message');
        const errorDiv = document.getElementById('error-message');
        const loadingSpinner = document.getElementById('loadingSpinner');

        function showPreview(imageUrl, filename) {
            previewDiv.innerHTML = ''; // 기존 내용 지우기
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = `미리보기: ${filename}`; // alt 속성 추가
            img.onerror = () => { // 이미지 로드 실패 시
                previewDiv.innerHTML = `<p>⚠️ 이미지를 불러올 수 없습니다: ${filename}</p>`;
            };
            previewDiv.appendChild(img);
        }

        form.onsubmit = async (e) => {
            e.preventDefault(); // 기본 제출 동작 방지

            if (!imageInput.files || imageInput.files.length === 0) {
                errorDiv.textContent = '⚠️ 이미지를 선택해주세요.';
                return;
            }

            resultList.innerHTML = ''; // 이전 결과 지우기
            previewDiv.innerHTML = '<p>결과 목록에서 항목을 선택하세요.</p>'; // 미리보기 초기화
            statusDiv.textContent = '⏳ 검색 중...'; // 상태 메시지 업데이트
            errorDiv.textContent = ''; // 오류 메시지 초기화
            loadingSpinner.style.display = 'inline-block'; // 로딩 스피너 표시
            submitButton.disabled = true; // 버튼 비활성화

            const formData = new FormData(form);

            try {
                const response = await fetch('/find_faces/', {
                    method: 'POST',
                    body: formData
                });

                // 응답 상태 코드 확인
                if (!response.ok) {
                    let errorDetail = `서버 오류 (${response.status} ${response.statusText})`;
                    try {
                        // FastAPI 오류 응답 형식 (detail 키) 시도
                        const errData = await response.json();
                        errorDetail = errData.detail || errorDetail;
                    } catch (jsonError) {
                        // JSON 파싱 실패 시 응답 텍스트 사용 시도
                        try {
                            const errText = await response.text();
                            if (errText) errorDetail = `${errorDetail}: ${errText}`;
                        } catch (textError) {
                            // 그것도 실패하면 원래 오류 메시지 사용
                        }
                    }
                    throw new Error(errorDetail); // 에러 발생시켜 catch 블록으로 이동
                }

                // 성공 응답 처리 (JSON 파싱)
                const data = await response.json();
                statusDiv.textContent = `✅ "${data.uploaded_filename}" 검색 완료. ${data.found_similar_images.length}개의 유사한 이미지를 찾았습니다.`;

                if (data.found_similar_images.length === 0) {
                    resultList.innerHTML = '<li>결과 없음: 유사한 이미지를 찾지 못했습니다.</li>';
                } else {
                    data.found_similar_images.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.setAttribute('role', 'button'); // 접근성 향상
                        li.tabIndex = 0; // 키보드 포커스 가능하게

                        const img = document.createElement('img');
                        // item.url을 썸네일과 전체보기에 모두 사용
                        img.src = item.url;
                        img.className = 'thumbnail';
                        img.alt = item.original_name; // alt 속성 추가
                        img.loading = 'lazy'; // 이미지 지연 로딩

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'result-info';

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'result-name';
                        // item.original_name을 표시
                        nameSpan.textContent = item.original_name;
                        nameSpan.title = item.original_name; // 이름 길 경우 툴팁으로 전체 보기

                        const distSpan = document.createElement('span');
                        distSpan.className = 'result-dist';
                        // item.distance 표시
                        distSpan.textContent = `거리: ${item.distance}`;

                        infoDiv.appendChild(nameSpan);
                        infoDiv.appendChild(distSpan);

                        li.appendChild(img);
                        li.appendChild(infoDiv);

                        // 클릭 이벤트: item.url을 사용하여 미리보기 표시
                        const selectItem = () => {
                            // 모든 li에서 'selected' 클래스 제거
                            document.querySelectorAll('#result-list li').forEach(el => el.classList.remove('selected'));
                            // 현재 클릭/선택된 li에 'selected' 클래스 추가
                            li.classList.add('selected');
                            // 미리보기 함수 호출
                            showPreview(item.url, item.original_name);
                        };

                        li.onclick = selectItem;
                        // 키보드 Enter 키로도 선택 가능하게
                        li.onkeydown = (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                selectItem();
                            }
                        };

                        resultList.appendChild(li);

                        // 첫 번째 결과는 자동으로 선택 및 미리보기 표시
                        if (index === 0) {
                            selectItem();
                        }
                    });
                }

            } catch (error) {
                // 네트워크 오류 또는 위에서 throw된 오류 처리
                console.error('Fetch Error:', error);
                errorDiv.textContent = `❌ 오류 발생: ${error.message}`;
                statusDiv.textContent = ''; // 성공 메시지 제거
            } finally {
                // 작업 완료 후 정리
                loadingSpinner.style.display = 'none'; // 로딩 스피너 숨기기
                submitButton.disabled = false; // 버튼 활성화
                // 파일 입력 필드 초기화는 사용자가 원할 경우 주석 해제
                // imageInput.value = '';
            }
        };

        // 파일 선택 시 오류 메시지 초기화
        imageInput.onchange = () => {
            errorDiv.textContent = '';
        };

    </script>
</body>
</html>
