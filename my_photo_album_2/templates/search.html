<!DOCTYPE html>
<html>
<head>
    <title>ìœ ì‚¬ ì–¼êµ´ ì°¾ê¸°</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f4f4; color: #333; }
        .container { display: flex; gap: 20px; margin-top: 20px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-wrap: wrap; /* ë°˜ì‘í˜• ê³ ë ¤ */ }
        .left-panel, .right-panel { flex: 1; min-width: 300px; /* ìµœì†Œ ë„ˆë¹„ ì§€ì • */ }
        .right-panel { border-left: 1px solid #eee; padding-left: 20px; }
        h1, h2 { color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #uploadForm { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #uploadForm input[type="file"] { border: 1px solid #ccc; padding: 8px; border-radius: 4px; background-color: #fff; }
        #uploadForm button { padding: 10px 18px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        #uploadForm button:hover { background-color: #0056b3; }
        #uploadForm button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #result-list { list-style: none; padding: 0; border: 1px solid #eee; max-height: 65vh; overflow-y: auto; border-radius: 4px; background-color: #fff; }
        #result-list li { padding: 10px 12px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; transition: background-color 0.2s ease; gap: 10px; }
        #result-list li:last-child { border-bottom: none; }
        #result-list li:hover { background-color: #f0f8ff; }
        #result-list li.selected { background-color: #d0e0ff; font-weight: bold; }
        img.thumbnail { width: 45px; height: 45px; object-fit: cover; border: 1px solid #ccc; border-radius: 4px; flex-shrink: 0; /* í¬ê¸° ê³ ì • */ }
        .result-info { display: flex; flex-direction: column; font-size: 0.9em; overflow: hidden; /* ì´ë¦„ ê¸¸ ê²½ìš° ëŒ€ë¹„ */ }
        .result-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; /* ì´ë¦„ ê¸¸ ê²½ìš° ... ì²˜ë¦¬ */ }
        .result-dist { color: #666; font-size: 0.85em; }
        #image-preview { text-align: center; min-height: 200px; /* ì´ˆê¸° ë†’ì´ */ display: flex; align-items: center; justify-content: center; background-color: #fafafa; border-radius: 4px; border: 1px dashed #ccc; }
        #image-preview img { max-width: 100%; max-height: 75vh; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; }
        #image-preview p { color: #888; font-size: 0.9em; }
        #status-message { margin-top: 15px; font-weight: bold; color: #333; }
        #error-message { color: #dc3545; margin-top: 10px; font-weight: bold; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #007bff; width: 20px; height: 20px; animation: spin 1.5s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .right-panel { border-left: none; border-top: 1px solid #eee; padding-left: 0; padding-top: 20px; margin-top: 20px; }
            #result-list { max-height: 40vh; }
            #image-preview img { max-height: 50vh; }
        }
    </style>
</head>
<body>
    <h1>ğŸ” ìœ ì‚¬ ì–¼êµ´ ì°¾ê¸°</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="imageInput" name="image" accept="image/*" required>
        <button type="submit" id="submitButton">ì°¾ê¸°</button>
        <div class="loader" id="loadingSpinner"></div>
    </form>
    <div id="status-message"></div>
    <div id="error-message"></div>

    <div class="container">
        <div class="left-panel">
            <h2>ê²°ê³¼ ëª©ë¡</h2>
            <ul id="result-list">
                <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </ul>
        </div>
        <div class="right-panel">
            <h2>ë¯¸ë¦¬ë³´ê¸°</h2>
            <div id="image-preview"><p>ê²°ê³¼ ëª©ë¡ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const imageInput = document.getElementById('imageInput');
        const submitButton = document.getElementById('submitButton');
        const resultList = document.getElementById('result-list');
        const previewDiv = document.getElementById('image-preview');
        const statusDiv = document.getElementById('status-message');
        const errorDiv = document.getElementById('error-message');
        const loadingSpinner = document.getElementById('loadingSpinner');

        function showPreview(imageUrl, filename) {
            previewDiv.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = `ë¯¸ë¦¬ë³´ê¸°: ${filename}`; // alt ì†ì„± ì¶”ê°€
            img.onerror = () => { // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ
                previewDiv.innerHTML = `<p>âš ï¸ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${filename}</p>`;
            };
            previewDiv.appendChild(img);
        }

        form.onsubmit = async (e) => {
            e.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë™ì‘ ë°©ì§€

            if (!imageInput.files || imageInput.files.length === 0) {
                errorDiv.textContent = 'âš ï¸ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                return;
            }

            resultList.innerHTML = ''; // ì´ì „ ê²°ê³¼ ì§€ìš°ê¸°
            previewDiv.innerHTML = '<p>ê²°ê³¼ ëª©ë¡ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>'; // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
            statusDiv.textContent = 'â³ ê²€ìƒ‰ ì¤‘...'; // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            errorDiv.textContent = ''; // ì˜¤ë¥˜ ë©”ì‹œì§€ ì´ˆê¸°í™”
            loadingSpinner.style.display = 'inline-block'; // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
            submitButton.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”

            const formData = new FormData(form);

            try {
                const response = await fetch('/find_faces/', {
                    method: 'POST',
                    body: formData
                });

                // ì‘ë‹µ ìƒíƒœ ì½”ë“œ í™•ì¸
                if (!response.ok) {
                    let errorDetail = `ì„œë²„ ì˜¤ë¥˜ (${response.status} ${response.statusText})`;
                    try {
                        // FastAPI ì˜¤ë¥˜ ì‘ë‹µ í˜•ì‹ (detail í‚¤) ì‹œë„
                        const errData = await response.json();
                        errorDetail = errData.detail || errorDetail;
                    } catch (jsonError) {
                        // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì‘ë‹µ í…ìŠ¤íŠ¸ ì‚¬ìš© ì‹œë„
                        try {
                            const errText = await response.text();
                            if (errText) errorDetail = `${errorDetail}: ${errText}`;
                        } catch (textError) {
                            // ê·¸ê²ƒë„ ì‹¤íŒ¨í•˜ë©´ ì›ë˜ ì˜¤ë¥˜ ë©”ì‹œì§€ ì‚¬ìš©
                        }
                    }
                    throw new Error(errorDetail); // ì—ëŸ¬ ë°œìƒì‹œì¼œ catch ë¸”ë¡ìœ¼ë¡œ ì´ë™
                }

                // ì„±ê³µ ì‘ë‹µ ì²˜ë¦¬ (JSON íŒŒì‹±)
                const data = await response.json();
                statusDiv.textContent = `âœ… "${data.uploaded_filename}" ê²€ìƒ‰ ì™„ë£Œ. ${data.found_similar_images.length}ê°œì˜ ìœ ì‚¬í•œ ì´ë¯¸ì§€ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;

                if (data.found_similar_images.length === 0) {
                    resultList.innerHTML = '<li>ê²°ê³¼ ì—†ìŒ: ìœ ì‚¬í•œ ì´ë¯¸ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
                } else {
                    data.found_similar_images.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.setAttribute('role', 'button'); // ì ‘ê·¼ì„± í–¥ìƒ
                        li.tabIndex = 0; // í‚¤ë³´ë“œ í¬ì»¤ìŠ¤ ê°€ëŠ¥í•˜ê²Œ

                        const img = document.createElement('img');
                        // item.urlì„ ì¸ë„¤ì¼ê³¼ ì „ì²´ë³´ê¸°ì— ëª¨ë‘ ì‚¬ìš©
                        img.src = item.url;
                        img.className = 'thumbnail';
                        img.alt = item.original_name; // alt ì†ì„± ì¶”ê°€
                        img.loading = 'lazy'; // ì´ë¯¸ì§€ ì§€ì—° ë¡œë”©

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'result-info';

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'result-name';
                        // item.original_nameì„ í‘œì‹œ
                        nameSpan.textContent = item.original_name;
                        nameSpan.title = item.original_name; // ì´ë¦„ ê¸¸ ê²½ìš° íˆ´íŒìœ¼ë¡œ ì „ì²´ ë³´ê¸°

                        const distSpan = document.createElement('span');
                        distSpan.className = 'result-dist';
                        // item.distance í‘œì‹œ
                        distSpan.textContent = `ê±°ë¦¬: ${item.distance}`;

                        infoDiv.appendChild(nameSpan);
                        infoDiv.appendChild(distSpan);

                        li.appendChild(img);
                        li.appendChild(infoDiv);

                        // í´ë¦­ ì´ë²¤íŠ¸: item.urlì„ ì‚¬ìš©í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                        const selectItem = () => {
                            // ëª¨ë“  liì—ì„œ 'selected' í´ë˜ìŠ¤ ì œê±°
                            document.querySelectorAll('#result-list li').forEach(el => el.classList.remove('selected'));
                            // í˜„ì¬ í´ë¦­/ì„ íƒëœ liì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
                            li.classList.add('selected');
                            // ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ í˜¸ì¶œ
                            showPreview(item.url, item.original_name);
                        };

                        li.onclick = selectItem;
                        // í‚¤ë³´ë“œ Enter í‚¤ë¡œë„ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ
                        li.onkeydown = (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                selectItem();
                            }
                        };

                        resultList.appendChild(li);

                        // ì²« ë²ˆì§¸ ê²°ê³¼ëŠ” ìë™ìœ¼ë¡œ ì„ íƒ ë° ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                        if (index === 0) {
                            selectItem();
                        }
                    });
                }

            } catch (error) {
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ìœ„ì—ì„œ throwëœ ì˜¤ë¥˜ ì²˜ë¦¬
                console.error('Fetch Error:', error);
                errorDiv.textContent = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                statusDiv.textContent = ''; // ì„±ê³µ ë©”ì‹œì§€ ì œê±°
            } finally {
                // ì‘ì—… ì™„ë£Œ í›„ ì •ë¦¬
                loadingSpinner.style.display = 'none'; // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
                submitButton.disabled = false; // ë²„íŠ¼ í™œì„±í™”
                // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”ëŠ” ì‚¬ìš©ìê°€ ì›í•  ê²½ìš° ì£¼ì„ í•´ì œ
                // imageInput.value = '';
            }
        };

        // íŒŒì¼ ì„ íƒ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ ì´ˆê¸°í™”
        imageInput.onchange = () => {
            errorDiv.textContent = '';
        };

    </script>
</body>
</html>
